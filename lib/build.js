const e=require("fs"),r=require("util"),s=require("chalk"),t=require("chokidar"),i=require("easy-table"),n=require("open"),o=require("ora"),c=require("scp2"),l=require("semver"),a=require("webpack"),u=require("webpack-dev-server"),{errorCb:d,frame:p,openPath:g,proxy:f,successCb:b,uploadOpts:S,useTs:E}=require("../config/bruce"),{BUILD_TEXT:j,FormatBool:h,QUESTION_TEXT:y}=require("../i18n"),{BuildAnswer:q,DllAnswer:w}=require("../pipe"),{HOST:O,IGNORE_DEPS:k}=require("../util/getting"),{AbsPath:m,AsyncTo:x,BuildCb:U,DataType:_,DiffArray:T,GetUrl:A,IsEmptyArray:L,IsExist:P,IsMpa:v,ReadEntry:B,ReadFolder:D,ShowMsg:F,ShowTitle:I}=require("../util/setting");function M(e){let r=!1;if(v()){const s=D("src/pages");s.reduce(((r,s)=>{const t=`src/pages/${s}/index.${e?"tsx":"jsx"}`,i=t.replace(/sx*$/g,"s");return P(t)&&(r+=1),P(i)&&(r+=1),r}),0)===s.length&&(r=!0)}else{let s=0;const t="src/index."+(e?"tsx":"jsx"),i=t.replace(/sx*$/g,"s");P(t)&&(s+=1),P(i)&&(s+=1),1===s&&(r=!0)}return r}function N(r){const s=B();return s.reduce(((t,i)=>{const n=`src${s.length>1?"/pages/"+i:""}/index.${r?"tsx":"jsx"}`,o=n.replace(/sx/g,"s"),c=P(n)?m(n):P(o)?m(o):"";if(c){const r=["@babel/polyfill","core-js","regenerator-runtime"],s=e.readFileSync(c,"utf8");return r.some((e=>s.includes(e)))?t+1:t}return t}),0)>0}function C(){const{dependencies:e={}}=require(m("package.json")),r=require(m("dist/static/vendor.json")),s=Object.keys(e).sort().reduce(((e,r)=>(k.every((e=>!r.includes(e)))&&e.push(r),e)),[]),t=T(r,s),i=T(s,r);return L(t)&&L(i)}async function R(){const{VENDOR:r}=await w(),s=require("../config/webpack.dll"),[t,i]=await U(s(r));if(t||!i)F("red",j.dllFail),process.exit(1);else{const s=m("dist/static/vendor.json"),t=JSON.stringify(r,null,"\t");e.writeFileSync(s,t,"utf8"),F("green",j.dllSucceed)}}function $(e){const{MODE:r,USE_ANALYZE:t,USE_COMPRESS:n,USE_CSSLINT:o,USE_ES6:c,USE_HASH:l,USE_JSLINT:a,USE_POLYFILL:u,USE_TIMED:d,USE_UPLOAD:p}=e,{name:g}=require(m("package.json")),f={name:g,mode:j.table.env[r],csslint:o,jslint:a,es6:c,polyfill:u,hash:l,timed:d,compress:n,analyze:t,upload:p},b=new i;Object.entries(f).filter((e=>void 0!==e[1])).forEach(((e,r)=>{const t=j.table[e[0]],i=_(e[1],"boolean")?h(e[1]):e[1];b.cell("title",s.black[`bg${r%2==0?"Blue":"Magenta"}Bright`](t)),b.cell("desc",s.cyanBright(i)),b.newRow()})),console.log("\n"+b.print())}async function H(e){const s=r.promisify(c.scp)(m("dist/"+e),S(e)),t=o(j.uploading).start(),[i]=await x(s);t.stop(),i?(console.log(i),F("red",j.uploadFail)):F("green",j.uploadSucceed)}module.exports=async function(){if(I("build"),!P("brucerc.js"))return F("red",j.judgeBrucerc);if(!P("package.json"))return F("red",j.judgePackage);if(!P("src"))return F("red",j.judgeSrc);if(!P("node_modules"))return F("red",j.judgeModules);const{dependencies:{"@babel/polyfill":e,"core-js":r},name:i,version:o}=require(m("package.json")),c=N(E);if(E&&!P("tsconfig.json"))return F("red",j.judgeTsconfig);if(!M(E))return F("red",j.judgeEntry);if(c){if(e)return F("red",j.judgePolyfill);if(r&&l.lt(r,"3.0.0"))return F("red",j.judgeCorejs)}"default"===p||P("dist/static")&&C()||await R();const h=await q(c),{MODE:w}=h;if("dev"===w){const{PORT:e,USE_OPEN:r}=h,i=require("../config/webpack.dev"),o=a(i(h)),c=new u(o,{contentBase:m("dist"),disableHostCheck:!0,historyApiFallback:!0,host:O,hot:!0,open:!1,overlay:!0,port:e,proxy:f,publicPath:A(e)+"/",quiet:!0}),l=t.watch([m("brucerc.js"),m("package.json"),m("tsconfig.json"),m("src/global.d.ts")]);c.listen(e,O,(t=>{if(t)F("red",j.buildFail);else{const t=A(e,g),i=A(e,g,!0);console.log(s.yellowBright(j.listening)),console.log(j.listLocalhost+s.blueBright(t)),console.log(j.listNetwork+s.blueBright(i)),r&&n(t,{app:"chrome"})}})),l.on("change",(e=>{const r=e.replace(/\\/g,"/").split("/").pop();console.log(j.watch(r)),process.exit(1)}))}else{$(h);const{MODE:e,USE_UPLOAD:r}=h,s=require("../config/webpack.prod")(Object.assign(h,{HAS_POLYFILL:c})),[t,n]=await U(s);t||!n?(F("red",j.buildFail(i,o,y.modeMap[e])),d&&d(t)):(F("green",j.buildSucceed(i,o,y.modeMap[e])),b&&b(e,s.output.path),r&&S&&H(e))}};