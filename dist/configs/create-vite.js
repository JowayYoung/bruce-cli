var x=this&&this.__awaiter||function(t,e,s,o){return new(s||(s=Promise))((function(i,n){function r(t){try{c(o.next(t))}catch(t){n(t)}}function l(t){try{c(o.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,l)}c((o=o.apply(t,e||[])).next())}))};import{watch as w}from"node:fs";import{basename as _,dirname as o}from"node:path";import{fileURLToPath as l}from"node:url";import $ from"@vitejs/plugin-basic-ssl";import F from"@vitejs/plugin-react";import{AbsPath as S,IsEmptyObject as E}from"@yangzw/bruce-us/dist/node.js";import J from"eslint-formatter-pretty";import P from"open";import R from"postcss-preset-env";import U from"stylelint-formatter-pretty";import{createServer as V}from"vite";import k from"vite-plugin-eslint";import A from"vite-plugin-html-config";import{viteStaticCopy as H}from"vite-plugin-static-copy";import I from"vite-plugin-stylelint";import{JudgeFile as L}from"../utils/index.js";import W from"./parse-config.js";export default function B(t){return x(this,void 0,void 0,(function*(){const e=o(l(import.meta.url)),{alias:s,browsers:i,copyFiles:n,eslintIgnores:r,eslintRules:c,linkAssets:p,openPages:m,proxy:a,proxyHost:f,publicPath:u,scriptAssets:d,style:v,stylelintIgnores:y,stylelintRules:g}=yield W(),{port:h,useCsslint:j,useHttps:b,useJslint:N,useOpener:O}=t,C=yield V({base:"function"==typeof u?u("dev"):u,configFile:!1,css:{postcss:{plugins:[R({browsers:i})]}},define:{RUN_ENV:JSON.stringify("dev"),"process.env.NODE_ENV":JSON.stringify("development"),"process.env.RUN_ENV":JSON.stringify("dev")},mode:"development",plugins:[b?$():null,N?k({cacheLocation:S("node_modules/.cache/eslint-vite-plugin/.eslintcache"),exclude:["node_modules",...r].map((t=>S(t))),extensions:["js","ts","jsx","tsx"],formatter:J,overrideConfig:{rules:c},overrideConfigFile:S("../../node_modules/@yangzw/bruce-std/dist/eslintrc.cjs",e)}):null,F(),A({favicon:"assets/img/favicon.ico",links:"function"==typeof p?p("dev"):p,scripts:[..."function"==typeof d?d("dev"):d,{src:`./${_(L("src"))}`,type:"module"}]}),H({targets:("function"==typeof n?n("dev"):n).filter((t=>t.from.startsWith("src"))).map((t=>({dest:t.to,src:t.from.replace(/^(src)?\/?/,"")})))}),j?I(Object.assign({cacheLocation:S("node_modules/.cache/stylelint-vite-plugin/.stylelintcache"),configFile:S("../../node_modules/@yangzw/bruce-std/dist/stylelint.config.js",e),customSyntax:`postcss-${v}`,exclude:["node_modules",...y].map((t=>S(t))),formatter:U},E(g)?{}:{config:{rules:g}})):null].filter(Boolean),resolve:{alias:Object.assign({"@":S("src")},s),mainFields:["module","jsnext","jsnext:main","browser","main"]},root:S("./src"),server:{host:f||!0,port:h,proxy:a}});yield C.listen(),C.printUrls();const z=[...new Set(m.length?m:[""])];if(O){const{host:t,port:e}=C.config.server;yield z.reduce(((s,o)=>x(this,void 0,void 0,(function*(){const i=/^https:?/.test(o)?o:`${b?"https":"http"}://${!0===t?"localhost":t}:${e}${o.startsWith("/")?o:`/${o}`}`;yield s,yield P(i,{app:{name:"browser"}})}))),Promise.resolve())}const B=L("","configFile"),D=_(B);w(B,{persistent:!0},((t,e)=>x(this,void 0,void 0,(function*(){"change"===t&&e===D&&(yield C.close(),yield C.restart())}))))}))}