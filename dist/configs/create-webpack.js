var x=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))((function(r,n){function i(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var s;e.done?r(e.value):(s=e.value,s instanceof t?s:new t((function(e){e(s)}))).then(i,l)}a((o=o.apply(e,s||[])).next())}))},B=this&&this.__rest||function(e,s){var t={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&s.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)s.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(t[o[r]]=e[o[r]])}return t};import{dirname as t}from"path";import{stdout as D}from"process";import{fileURLToPath as l}from"url";import{AbsPath as N,AsyncTo as M,IsEmptyObject as S}from"@yangzw/bruce-us/dist/node.js";import Y from"webpackbar";import{BundleAnalyzerPlugin as G}from"webpack-bundle-analyzer";import T from"compression-webpack-plugin";import q from"copy-webpack-plugin";import K from"css-minimizer-webpack-plugin";import Q from"dayjs";import z from"eslint-formatter-pretty";import k from"eslint-webpack-plugin";import X from"html-webpack-plugin";import Z from"html-webpack-tags-plugin";import ee from"mini-css-extract-plugin";import J from"postcss-preset-env";import L from"stylelint-webpack-plugin";import P from"stylelint-formatter-pretty";import se from"terser-webpack-plugin";import te from"webpack";import oe from"webpack-notifier";import{ACTION_TEXT as r}from"../langs/index.js";import{BROWSERS_ES5 as re,BROWSERS_ES6 as ne,JudgeFile as U}from"../utils/index.js";import V from"./parse-config.js";export default function ie(e){var s,o;return x(this,void 0,void 0,(function*(){const n=t(l(import.meta.url)),{alias:i,browsers:a,copyFiles:c,eslintIgnores:p,eslintRules:m,linkAssets:u,publicPath:d,scriptAssets:f,style:b,stylelintIgnores:g,stylelintRules:h,transpileDeps:y}=yield V(),{mode:w,polyfill:x,useAnalyzer:j,useCompressor:v,useCsslint:_,useHash:O,useJslint:$,useTimer:C}=e,E={babelrc:!1,cacheDirectory:!0,cwd:N("../..",n)},I={custom:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:a},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},dynamic:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{presets:["@babel/preset-typescript","@babel/preset-react"]})},es5:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:re},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},es6:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:ne},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})}}[x],F={loader:"css-loader",options:{importLoaders:2}},A={loader:"resolve-url-loader"},H={loader:"postcss-loader",options:{postcssOptions:{plugins:[J({browsers:a})]}}},R={loader:ee.loader},W=`dist/${w}${C?Q().format("-YYYYMMDD-HHmmss"):""}`,ie="function"==typeof c?c(w):c,le={devtool:"test"===w&&"source-map",entry:{index:U("src")},mode:"production",module:{rules:[Object.assign(y.length?{include:[N("src"),...y.filter(Boolean).map((e=>N(`node_modules/${e}`)))]}:{exclude:/node_modules/,include:/src/},{test:/\.(jsx?|tsx?)$/,use:[I]}),{include:/(node_modules|src)/,test:/\.css$/,use:[R,F,H]},{exclude:/node_modules/,include:/src/,test:/\.less$/,use:[R,F,H,A,{loader:"less-loader"}]},{exclude:/node_modules/,include:/src/,test:/\.scss$/,use:[R,F,H,A,{loader:"sass-loader",options:{sassOptions:{fiber:!1},sourceMap:!0}}]},{exclude:/node_modules/,generator:{filename:"img/[name].[contenthash:8][ext]"},include:/src/,parser:{dataUrlCondition:{maxSize:10240}},test:/\.(gif|jpe?g|png|webp)$/,type:"asset"},{exclude:/node_modules/,generator:{filename:"font/[name].[contenthash:8][ext]"},include:/src/,test:/\.(eot|otf|ttf|woff2?)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.md$/,use:[{loader:"html-loader"},{loader:"markdown-loader"}]},{exclude:/node_modules/,generator:{filename:"media/[name].[contenthash:8][ext]"},include:/src/,test:/\.(wv|aac|ape|mp3|ogg|wav|alac|flac|opus|rm|3gb|asf|asx|avi|dat|flv|m4v|mkv|mov|mp4|vob|wmv|rmvb|pdf)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.txt/,type:"asset/source"},{exclude:/node_modules/,include:/src/,test:/\.svg$/,type:"asset/inline"}]},optimization:{minimizer:[new K,new se({extractComments:!1,terserOptions:{compress:{drop_console:"test"!==w},format:{comments:!1}}})],runtimeChunk:{name:"manifest"},splitChunks:{cacheGroups:{common:{minChunks:2,name:"common",priority:5,reuseExistingChunk:!0,test:/src/},vendor:{chunks:"initial",name:"vendor",priority:10,test:/node_modules/}},chunks:"all"}},output:{filename:`js/[name].bundle${O?".[contenthash:8]":""}.js`,path:N(W),publicPath:"function"==typeof d?d(w):d},performance:{assetFilter:e=>"vendor.bundle.js"!==e&&!/\.map$/.test(e),maxAssetSize:512e3,maxEntrypointSize:1024e3},plugins:[new te.DefinePlugin({RUN_ENV:JSON.stringify(w)}),new Y({name:"Webpack Build"}),j?new G:null,v?new T({test:/\.(css|js)$/,threshold:10240}):null,ie.length?new q({patterns:ie.filter((e=>e.from.startsWith("src"))).map((e=>({from:N(e.from),to:N(`${W}/${e.to}`)})))}):null,$?new k({cacheLocation:N("node_modules/.cache/eslint-webpack-plugin/.eslintcache"),context:N("src"),exclude:["node_modules",...p].map((e=>N(e))),extensions:["js","ts","jsx","tsx"],formatter:z,overrideConfig:{rules:m},overrideConfigFile:N("../../node_modules/@yangzw/bruce-std/dist/eslintrc.js",n)}):null,new X({chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:N("src/favicon.ico"),filename:"index.html",inject:"body",template:N("src/index.html")}),new Z({links:("function"==typeof u?u(w):u).map((e=>{const{href:s}=e;return{attributes:B(e,["href"]),path:s}})),scripts:["dynamic"===x?{append:!1,path:"https://polyfill.alicdn.com/polyfill.min.js"}:"",...("function"==typeof f?f(w):f).map((e=>{const{src:s}=e;return{append:!1,attributes:B(e,["src"]),path:s}}))].filter(Boolean),usePublicPath:!1}),new ee({filename:`css/[name].bundle${O?".[contenthash:8]":""}.css`,ignoreOrder:!0}),new oe({title:r.build}),_?new L(Object.assign({cacheLocation:N("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:N("../../node_modules/@yangzw/bruce-std/dist/stylelintrc.js",n),context:N("src"),customSyntax:`postcss-${b}`,exclude:["node_modules",...g].map((e=>N(e))),extensions:["css","scss","less"],formatter:P},S(h)?{}:{config:{rules:h}})):null].filter(Boolean),resolve:{alias:Object.assign({"@":N("src")},i),extensions:[".js",".ts",".jsx",".tsx",".json",".vue"],mainFields:["module","jsnext","jsnext:main","browser","main"],modules:[N("node_modules"),N("../../node_modules",n)]},resolveLoader:{modules:[N("../../node_modules",n)]}},ae=null!==(o=null===(s=le.output)||void 0===s?void 0:s.path)&&void 0!==o?o:"",ce=new Promise(((e,s)=>{te(le,((t,o)=>{!t&&o?(D.write(o.toString({children:!1,chunkModules:!1,chunks:!1,colors:!0,modules:!1})+"\n\n"),e({dist:ae,flag:!o.hasErrors()})):s(new Error("error"))}))})),[pe,me]=yield M(ce);return pe?{dist:ae,flag:!1}:me}))}