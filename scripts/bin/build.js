import{exit as Vo}from"process";import{AbsPath as E,CheckPath as Z,ReadJson as l,RemoveDir as jo}from"@yangzw/bruce-us/dist/node.js";import _e from"ora";import N from"webpack";import Ve from"webpack-dev-server";import{BrucercConfig as c}from"../../configs/config/index.js";import{DevWebpack as le,ProdWebpack as oo}from"../../configs/webpack/index.js";import{BUILD_TEXT as ro}from"../../constants/i18n/index.js";import{BuildApp as rt,CheckParams as it,JudgeFile as i,ShowMsg as et,ShowTitle as gt,UploadFiles as pt,WatchFiles as ft}from"../../constants/util/index.js";import{BuildAnswer as No}from"../../helpers/answer/index.js";export default async function We(){gt("build");const e=i("","configFile"),o=i("src");if(it(),!e)return et("red",ro.judgeBrucerc),Vo(1);if(!o)return et("red",ro.judgeIndexes),Vo(1);if(!Z("package.json"))return et("red",ro.judgePackage),Vo(1);if(!Z("node_modules"))return et("red",ro.judgeModules),Vo(1);const r={...await No(),...await c()};if(r.useTs&&!Z("tsconfig.json"))return et("red",ro.judgeTsconfig),Vo(1);if("dev"===r.mode){const e=_e(ro.doing1).start(),o=le(r),t=N(o),s=new Ve({allowedHosts:"all",headers:{"Access-Control-Allow-Origin":"*"},historyApiFallback:!0,host:r?.proxyHost||"local-ip",hot:!0,open:!!r.useOpener&&(!r.openPages?.length||r.openPages.filter(Boolean)),port:r.port,proxy:r.proxy,server:r.useHttps?"https":"http",static:{directory:E("dist")}},t);e.stop(),await s.start(),ft((e=>{console.log(ro.watch(e)),Vo(1)}))}else{const{name:e,version:o}=l("package.json"),t=_e(ro.doing1).start(),s=oo(r);!r.useTimer&&jo(`dist/${r.mode}`),t.stop();const[n,i]=await rt(s),d=s.output.path;if(n||!i)et("red",ro.undone1({mode:r.mode,name:e,ver:o})),r?.buildErrorCb?.({err:n,mode:r.mode,path:d}),Vo(1);else{if(et("green",ro.done1({mode:r.mode,name:e,ver:o})),r?.buildSuccessCb?.({mode:r.mode,path:d}),r.uploadOpts){const e=_e(ro.doing2).start(),o=await pt({mode:r.mode,opts:r.uploadOpts,path:d});e.stop(),o?et("green",ro.done2):et("red",ro.undone2)}Vo(1)}}}