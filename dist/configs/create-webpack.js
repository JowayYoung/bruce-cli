var x=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))((function(r,n){function i(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var s;e.done?r(e.value):(s=e.value,s instanceof t?s:new t((function(e){e(s)}))).then(i,l)}a((o=o.apply(e,s||[])).next())}))},D=this&&this.__rest||function(e,s){var t={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&s.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)s.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(t[o[r]]=e[o[r]])}return t};import{dirname as o}from"node:path";import{stdout as M}from"node:process";import{fileURLToPath as l}from"node:url";import{AbsPath as S,AsyncTo as Y,IsEmptyObject as E}from"@yangzw/bruce-us/dist/node.js";import G from"compression-webpack-plugin";import T from"copy-webpack-plugin";import q from"css-minimizer-webpack-plugin";import K from"dayjs";import J from"eslint-formatter-pretty";import k from"eslint-webpack-plugin";import Q from"html-webpack-plugin";import X from"html-webpack-tags-plugin";import Z from"mini-css-extract-plugin";import ee from"postcss-import";import R from"postcss-preset-env";import U from"stylelint-formatter-pretty";import I from"stylelint-webpack-plugin";import se from"terser-webpack-plugin";import te from"webpack";import oe from"webpackbar";import{BundleAnalyzerPlugin as re}from"webpack-bundle-analyzer";import ne from"webpack-notifier";import{ACTION_TEXT as m}from"../langs/index.js";import{BROWSERS_ES5 as ie,BROWSERS_ES6 as le,JudgeFile as L}from"../utils/index.js";import W from"./parse-config.js";export default function ae(e){return x(this,void 0,void 0,(function*(){var s,t;const r=o(l(import.meta.url)),{alias:n,browsers:i,copyFiles:a,eslintIgnores:c,eslintRules:p,linkAssets:u,publicPath:d,scriptAssets:f,style:b,stylelintIgnores:g,stylelintRules:h,transpileDeps:y}=yield W(),{mode:w,polyfill:x,useAnalyzer:v,useCompressor:j,useCsslint:_,useHash:O,useJslint:$,useTimer:z}=e,C={babelrc:!1,cacheDirectory:!0,cwd:S("../..",r)},P={custom:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:i},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},dynamic:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{presets:["@babel/preset-typescript","@babel/preset-react"]})},es5:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:ie},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},es6:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:le},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})}}[x],N={loader:"css-loader",options:{importLoaders:2}},B={loader:"resolve-url-loader"},F={loader:"postcss-loader",options:{postcssOptions:{plugins:[ee(),R({browsers:i})]}}},A={loader:Z.loader},H=`dist/${w}${z?K().format("-YYYYMMDD-HHmmss"):""}`,V="function"==typeof a?a(w):a,ae={devtool:"test"===w&&"source-map",entry:{index:L("src")},mode:"production",module:{rules:[{include:[S("src"),...y.map((e=>S(`node_modules/${e}`)))],test:/\.(jsx?|tsx?)$/,use:[P]},{include:/(node_modules|src)/,test:/\.css$/,use:[A,N,F]},{exclude:/node_modules/,include:/src/,test:/\.less$/,use:[A,N,F,B,{loader:"less-loader"}]},{exclude:/node_modules/,include:/src/,test:/\.scss$/,use:[A,N,F,B,{loader:"sass-loader",options:{sassOptions:{fiber:!1},sourceMap:!0}}]},{exclude:/node_modules/,generator:{filename:"img/[name].[contenthash:8][ext]"},include:/src/,parser:{dataUrlCondition:{maxSize:10240}},test:/\.(gif|jpe?g|png|webp)$/,type:"asset"},{exclude:/node_modules/,generator:{filename:"font/[name].[contenthash:8][ext]"},include:/src/,test:/\.(eot|otf|ttf|woff2?)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.md$/,use:[{loader:"html-loader"},{loader:"markdown-loader"}]},{exclude:/node_modules/,generator:{filename:"media/[name].[contenthash:8][ext]"},include:/src/,test:/\.(wv|aac|ape|mp3|ogg|wav|alac|flac|opus|rm|3gb|asf|asx|avi|dat|flv|m4v|mkv|mov|mp4|vob|wmv|rmvb|pdf)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.txt/,type:"asset/source"},{exclude:/node_modules/,include:/src/,test:/\.svg$/,type:"asset/inline"}]},optimization:{minimizer:[new q,new se({extractComments:!1,terserOptions:{compress:{drop_console:"test"!==w},format:{comments:!1}}})],runtimeChunk:{name:"manifest"},splitChunks:{cacheGroups:{common:{minChunks:2,name:"common",priority:5,reuseExistingChunk:!0,test:/src/},vendor:{chunks:"initial",name:"vendor",priority:10,test:/node_modules/}},chunks:"all"}},output:{filename:`js/[name].bundle${O?".[contenthash:8]":""}.js`,path:S(H),publicPath:"function"==typeof d?d(w):d},performance:{assetFilter:e=>"vendor.bundle.js"!==e&&!/\.map$/.test(e),maxAssetSize:512e3,maxEntrypointSize:1024e3},plugins:[new te.DefinePlugin({RUN_ENV:JSON.stringify(w),"process.env.NODE_ENV":JSON.stringify("production"),"process.env.RUN_ENV":JSON.stringify(w)}),new oe({name:"Webpack Build"}),v?new re:null,j?new G({test:/\.(css|js)$/,threshold:10240}):null,V.length?new T({patterns:V.filter((e=>e.from.startsWith("src"))).map((e=>({from:e.from,to:e.to})))}):null,$?new k({cacheLocation:S("node_modules/.cache/eslint-webpack-plugin/.eslintcache"),context:S("src"),exclude:["node_modules",...c].map((e=>S(e))),extensions:["js","ts","jsx","tsx"],formatter:J,overrideConfig:{rules:p},overrideConfigFile:S("../../node_modules/@yangzw/bruce-std/dist/eslintrc.cjs",r)}):null,new Q({chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:S("src/assets/img/favicon.ico"),filename:"index.html",inject:"body",template:S("src/index.html")}),new X({links:("function"==typeof u?u(w):u).map((e=>{const{href:s}=e;return{attributes:D(e,["href"]),path:s}})),scripts:["dynamic"===x?{append:!1,path:"https://polyfill.alicdn.com/polyfill.min.js"}:"",...("function"==typeof f?f(w):f).map((e=>{const{src:s}=e;return{append:!1,attributes:D(e,["src"]),path:s}}))].filter(Boolean),usePublicPath:!1}),new Z({filename:`css/[name].bundle${O?".[contenthash:8]":""}.css`,ignoreOrder:!0}),new ne({title:m.build}),_?new I(Object.assign({cacheLocation:S("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:S("../../node_modules/@yangzw/bruce-std/dist/stylelint.config.js",r),context:S("src"),customSyntax:`postcss-${b}`,exclude:["node_modules",...g].map((e=>S(e))),extensions:["css","scss","less"],formatter:U},E(h)?{}:{config:{rules:h}})):null].filter(Boolean),resolve:{alias:Object.assign({"@":S("src")},n),extensions:[".js",".ts",".jsx",".tsx",".json",".vue"],mainFields:["module","jsnext","jsnext:main","browser","main"],modules:[S("node_modules"),S("../../node_modules",r)]},resolveLoader:{modules:[S("../../node_modules",r)]}},ce=null!==(t=null===(s=ae.output)||void 0===s?void 0:s.path)&&void 0!==t?t:"",pe=new Promise(((e,s)=>{te(ae,((t,o)=>{!t&&o?(M.write(o.toString({children:!1,chunkModules:!1,chunks:!1,colors:!0,modules:!1})+"\n\n"),e({dist:ce,flag:!o.hasErrors()})):s(new Error("error"))}))})),[me,ue]=yield Y(pe);return me?{dist:ce,flag:!1}:ue}))}