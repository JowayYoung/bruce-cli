var x=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))((function(r,n){function i(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var s;e.done?r(e.value):(s=e.value,s instanceof t?s:new t((function(e){e(s)}))).then(i,l)}a((o=o.apply(e,s||[])).next())}))},D=this&&this.__rest||function(e,s){var t={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&s.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)s.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(t[o[r]]=e[o[r]])}return t};import{dirname as t}from"path";import{stdout as M}from"process";import{fileURLToPath as l}from"url";import{AbsPath as S,AsyncTo as Y,IsEmptyObject as z}from"@yangzw/bruce-us/dist/node.js";import G from"webpackbar";import{BundleAnalyzerPlugin as T}from"webpack-bundle-analyzer";import q from"compression-webpack-plugin";import K from"copy-webpack-plugin";import Q from"css-minimizer-webpack-plugin";import X from"dayjs";import E from"eslint-formatter-pretty";import A from"eslint-webpack-plugin";import Z from"html-webpack-plugin";import ee from"html-webpack-tags-plugin";import se from"mini-css-extract-plugin";import te from"webpack-notifier";import P from"postcss-preset-env";import R from"stylelint-formatter-pretty";import U from"stylelint-webpack-plugin";import oe from"terser-webpack-plugin";import re from"webpack";import{ACTION_TEXT as r}from"../langs/index.js";import{BROWSERS_ES5 as ne,BROWSERS_ES6 as ie,JudgeFile as V}from"../utils/index.js";import W from"./parse-config.js";export default function le(e){var s,o;return x(this,void 0,void 0,(function*(){const n=t(l(import.meta.url)),{alias:i,browsers:a,copyFiles:c,eslintIgnores:p,eslintRules:m,linkAssets:u,publicPath:d,scriptAssets:f,style:b,stylelintIgnores:g,stylelintRules:h,transpileDeps:y}=yield W(),{mode:w,polyfill:x,useAnalyzer:j,useCompressor:v,useCsslint:k,useHash:_,useJslint:O,useTimer:$}=e,C={babelrc:!1,cacheDirectory:!0,cwd:S("../..",n)},B={custom:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:a},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},dynamic:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{presets:["@babel/preset-typescript","@babel/preset-react"]})},es5:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:ne},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},es6:{loader:"babel-loader",options:Object.assign(Object.assign({},C),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:ie},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})}}[x],I={loader:"css-loader",options:{importLoaders:2}},F={loader:"resolve-url-loader"},L={loader:"postcss-loader",options:{postcssOptions:{plugins:[P({browsers:a})]}}},H={loader:se.loader},N=`dist/${w}${$?X().format("-YYYYMMDD-HHmmss"):""}`,J="function"==typeof c?c(w):c,le={devtool:"test"===w&&"source-map",entry:{index:V("src")},mode:"production",module:{rules:[Object.assign(y.length?{include:[S("src"),...y.filter(Boolean).map((e=>S(`node_modules/${e}`)))]}:{exclude:/node_modules/,include:/src/},{test:/\.(jsx?|tsx?)$/,use:[B]}),{include:/(node_modules|src)/,test:/\.css$/,use:[H,I,L]},{exclude:/node_modules/,include:/src/,test:/\.less$/,use:[H,I,L,F,{loader:"less-loader"}]},{exclude:/node_modules/,include:/src/,test:/\.scss$/,use:[H,I,L,F,{loader:"sass-loader",options:{sassOptions:{fiber:!1},sourceMap:!0}}]},{exclude:/node_modules/,generator:{filename:"img/[name].[contenthash:8][ext]"},include:/src/,parser:{dataUrlCondition:{maxSize:10240}},test:/\.(gif|jpe?g|png|webp)$/,type:"asset"},{exclude:/node_modules/,generator:{filename:"font/[name].[contenthash:8][ext]"},include:/src/,test:/\.(eot|otf|ttf|woff2?)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.md$/,use:[{loader:"html-loader"},{loader:"markdown-loader"}]},{exclude:/node_modules/,generator:{filename:"media/[name].[contenthash:8][ext]"},include:/src/,test:/\.(wv|aac|ape|mp3|ogg|wav|alac|flac|opus|rm|3gb|asf|asx|avi|dat|flv|m4v|mkv|mov|mp4|vob|wmv|rmvb|pdf)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.txt/,type:"asset/source"},{exclude:/node_modules/,include:/src/,test:/\.svg$/,type:"asset/inline"}]},optimization:{minimizer:[new Q,new oe({extractComments:!1,terserOptions:{compress:{drop_console:"test"!==w},format:{comments:!1}}})],runtimeChunk:{name:"manifest"},splitChunks:{cacheGroups:{common:{minChunks:2,name:"common",priority:5,reuseExistingChunk:!0,test:/src/},vendor:{chunks:"initial",name:"vendor",priority:10,test:/node_modules/}},chunks:"all"}},output:{filename:`js/[name].bundle${_?".[contenthash:8]":""}.js`,path:S(N),publicPath:"function"==typeof d?d(w):d},performance:{assetFilter:e=>"vendor.bundle.js"!==e&&!/\.map$/.test(e),maxAssetSize:512e3,maxEntrypointSize:1024e3},plugins:[new re.DefinePlugin({RUN_ENV:JSON.stringify(w)}),new G({name:"Webpack Build"}),j?new T:null,v?new q({test:/\.(css|js)$/,threshold:10240}):null,J.length?new K({patterns:J.filter((e=>e.from.startsWith("src"))).map((e=>({from:S(e.from),to:S(`${N}/${e.to}`)})))}):null,O?new A({cacheLocation:S("node_modules/.cache/eslint-webpack-plugin/.eslintcache"),context:S("src"),exclude:["node_modules",...p].map((e=>S(e))),extensions:["js","ts","jsx","tsx"],formatter:E,overrideConfig:{rules:m},overrideConfigFile:S("../../node_modules/@yangzw/bruce-std/dist/eslintrc.js",n)}):null,new Z({chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:S("src/assets/img/favicon.ico"),filename:"index.html",inject:"body",template:S("src/index.html")}),new ee({links:("function"==typeof u?u(w):u).map((e=>{const{href:s}=e;return{attributes:D(e,["href"]),path:s}})),scripts:["dynamic"===x?{append:!1,path:"https://polyfill.alicdn.com/polyfill.min.js"}:"",...("function"==typeof f?f(w):f).map((e=>{const{src:s}=e;return{append:!1,attributes:D(e,["src"]),path:s}}))].filter(Boolean),usePublicPath:!1}),new se({filename:`css/[name].bundle${_?".[contenthash:8]":""}.css`,ignoreOrder:!0}),new te({title:r.build}),k?new U(Object.assign({cacheLocation:S("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:S("../../node_modules/@yangzw/bruce-std/dist/stylelintrc.js",n),context:S("src"),customSyntax:`postcss-${b}`,exclude:["node_modules",...g].map((e=>S(e))),extensions:["css","scss","less"],formatter:R},z(h)?{}:{config:{rules:h}})):null].filter(Boolean),resolve:{alias:Object.assign({"@":S("src")},i),extensions:[".js",".ts",".jsx",".tsx",".json",".vue"],mainFields:["module","jsnext","jsnext:main","browser","main"],modules:[S("node_modules"),S("../../node_modules",n)]},resolveLoader:{modules:[S("../../node_modules",n)]}},ae=null!==(o=null===(s=le.output)||void 0===s?void 0:s.path)&&void 0!==o?o:"",ce=new Promise(((e,s)=>{re(le,((t,o)=>{!t&&o?(M.write(o.toString({children:!1,chunkModules:!1,chunks:!1,colors:!0,modules:!1})+"\n\n"),e({dist:ae,flag:!o.hasErrors()})):s(new Error("error"))}))})),[pe,me]=yield Y(ce);return pe?{dist:ae,flag:!1}:me}))}