var g=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))((function(n,r){function i(e){try{a(o.next(e))}catch(e){r(e)}}function l(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var s;e.done?n(e.value):(s=e.value,s instanceof t?s:new t((function(e){e(s)}))).then(i,l)}a((o=o.apply(e,s||[])).next())}))},B=this&&this.__rest||function(e,s){var t={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&s.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)s.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(t[o[n]]=e[o[n]])}return t};import{dirname as e}from"path";import{stdout as D}from"process";import{fileURLToPath as i}from"url";import{AbsPath as $,AsyncTo as M,IsEmptyObject as N}from"@yangzw/bruce-us/dist/node.js";import Y from"webpackbar";import{BundleAnalyzerPlugin as G}from"webpack-bundle-analyzer";import X from"compression-webpack-plugin";import q from"copy-webpack-plugin";import K from"css-minimizer-webpack-plugin";import Q from"dayjs";import S from"eslint-formatter-pretty";import A from"eslint-webpack-plugin";import Z from"html-webpack-plugin";import ee from"html-webpack-tags-plugin";import se from"mini-css-extract-plugin";import te from"webpack-notifier";import J from"postcss-preset-env";import R from"stylelint-formatter-pretty";import k from"stylelint-webpack-plugin";import oe from"terser-webpack-plugin";import ne from"webpack";import{ACTION_TEXT as r}from"../langs/index.js";import{BROWSERS_ES5 as re,BROWSERS_ES6 as ie,JudgeFile as H}from"../utils/index.js";import V from"./parse-config.js";export default function le(s){var t,o;return g(this,void 0,void 0,(function*(){const n=e(i(import.meta.url)),{alias:l,browsers:a,copyFiles:c,eslintIgnores:m,eslintRules:p,linkAssets:u,publicPath:d,scriptAssets:f,style:b,stylelintIgnores:g,stylelintRules:h,transpileDeps:y}=yield V(),{mode:w,polyfill:x,useAnalyzer:j,useCompressor:v,useCsslint:_,useHash:O,useJslint:P,useTimer:z}=s,E={babelrc:!1,cacheDirectory:!0,cwd:$("../..",n)},C={custom:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:a},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},dynamic:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{presets:["@babel/preset-typescript","@babel/preset-react"]})},es5:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:re},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})},es6:{loader:"babel-loader",options:Object.assign(Object.assign({},E),{plugins:[["@babel/plugin-transform-runtime",{corejs:3}]],presets:[["@babel/preset-env",{corejs:3,targets:{browsers:ie},useBuiltIns:"usage"}],"@babel/preset-typescript","@babel/preset-react"]})}}[x],I={loader:"css-loader",options:{importLoaders:2}},F={loader:"resolve-url-loader"},T={loader:"postcss-loader",options:{postcssOptions:{plugins:[J({browsers:a})]}}},L={loader:se.loader},W=`dist/${w}${z?Q().format("-YYYYMMDD-HHmmss"):""}`,U="function"==typeof c?c(w):c,le={devtool:"test"===w&&"source-map",entry:{index:H("src")},mode:"production",module:{rules:[Object.assign(y.length?{include:[$("src"),...y.filter(Boolean).map((e=>$(`node_modules/${e}`)))]}:{exclude:/node_modules/,include:/src/},{test:/\.(jsx?|tsx?)$/,use:[C]}),{include:/(node_modules|src)/,test:/\.css$/,use:[L,I,T]},{exclude:/node_modules/,include:/src/,test:/\.less$/,use:[L,I,T,F,{loader:"less-loader"}]},{exclude:/node_modules/,include:/src/,test:/\.scss$/,use:[L,I,T,F,{loader:"sass-loader",options:{sassOptions:{fiber:!1},sourceMap:!0}}]},{exclude:/node_modules/,generator:{filename:"img/[name].[contenthash:8][ext]"},include:/src/,parser:{dataUrlCondition:{maxSize:10240}},test:/\.(gif|jpe?g|png|webp)$/,type:"asset"},{exclude:/node_modules/,generator:{filename:"font/[name].[contenthash:8][ext]"},include:/src/,test:/\.(eot|otf|ttf|woff2?)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.md$/,use:[{loader:"html-loader"},{loader:"markdown-loader"}]},{exclude:/node_modules/,generator:{filename:"media/[name].[contenthash:8][ext]"},include:/src/,test:/\.(wv|aac|ape|mp3|ogg|wav|alac|flac|opus|rm|3gb|asf|asx|avi|dat|flv|m4v|mkv|mov|mp4|vob|wmv|rmvb|pdf)$/,type:"asset/resource"},{exclude:/node_modules/,include:/src/,test:/\.txt/,type:"asset/source"},{exclude:/node_modules/,include:/src/,test:/\.svg$/,type:"asset/inline"}]},optimization:{minimizer:[new K,new oe({extractComments:!1,terserOptions:{compress:{drop_console:"test"!==w},format:{comments:!1}}})],runtimeChunk:{name:"manifest"},splitChunks:{cacheGroups:{common:{minChunks:2,name:"common",priority:5,reuseExistingChunk:!0,test:/src/},vendor:{chunks:"initial",name:"vendor",priority:10,test:/node_modules/}},chunks:"all"}},output:{filename:`js/[name].bundle${O?".[contenthash:8]":""}.js`,path:$(W),publicPath:"function"==typeof d?d(w):d},performance:{assetFilter:e=>"vendor.bundle.js"!==e&&!/\.map$/.test(e),maxAssetSize:512e3,maxEntrypointSize:1024e3},plugins:[new ne.DefinePlugin({RUN_ENV:JSON.stringify(w)}),new Y({name:"Webpack Build"}),j?new G:null,v?new X({test:/\.(css|js)$/,threshold:10240}):null,U.length?new q({patterns:U.filter((e=>e.from.startsWith("src"))).map((e=>({from:$(e.from),to:$(`${W}/${e.to}`)})))}):null,P?new A({cacheLocation:$("node_modules/.cache/eslint-webpack-plugin/.eslintcache"),context:$("src"),exclude:["node_modules",...m].map((e=>$(e))),extensions:["js","ts","jsx","tsx"],formatter:S,overrideConfig:{rules:p},overrideConfigFile:$("../../node_modules/@yangzw/bruce-std/dist/eslintrc.js",n)}):null,new Z({chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:$("src/assets/img/favicon.ico"),filename:"index.html",inject:"body",template:$("src/index.html")}),new ee({links:("function"==typeof u?u(w):u).map((e=>{const{href:s}=e;return{attributes:B(e,["href"]),path:s}})),scripts:["dynamic"===x?{append:!1,path:"https://polyfill.alicdn.com/polyfill.min.js"}:"",...("function"==typeof f?f(w):f).map((e=>{const{src:s}=e;return{append:!1,attributes:B(e,["src"]),path:s}}))].filter(Boolean),usePublicPath:!1}),new se({filename:`css/[name].bundle${O?".[contenthash:8]":""}.css`,ignoreOrder:!0}),new te({title:r.build}),_?new k(Object.assign({cacheLocation:$("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:$("../../node_modules/@yangzw/bruce-std/dist/stylelintrc.js",n),context:$("src"),customSyntax:`postcss-${b}`,exclude:["node_modules",...g].map((e=>$(e))),extensions:["css","scss","less"],formatter:R},N(h)?{}:{config:{rules:h}})):null].filter(Boolean),resolve:{alias:Object.assign({"@":$("src")},l),extensions:[".js",".ts",".jsx",".tsx",".json",".vue"],mainFields:["module","jsnext","jsnext:main","browser","main"],modules:[$("node_modules"),$("../../node_modules",n)]},resolveLoader:{modules:[$("../../node_modules",n)]}},ae=null!==(o=null===(t=le.output)||void 0===t?void 0:t.path)&&void 0!==o?o:"",ce=new Promise(((e,s)=>{ne(le,((t,o)=>{!t&&o?(D.write(o.toString({children:!1,chunkModules:!1,chunks:!1,colors:!0,modules:!1})+"\n\n"),e({dist:ae,flag:!o.hasErrors()})):s(new Error("error"))}))})),[me,pe]=yield M(ce);return me?{dist:ae,flag:!1}:pe}))}