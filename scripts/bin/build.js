import{exit as Ho}from"process";import{ReadJson as l,RemoveDir as kt}from"@yangzw/bruce-us/dist/node.js";import _e from"ora";import N from"webpack";import Ue from"webpack-dev-server";import{BrucercConfig as c}from"../../configs/config/index.js";import{DevWebpack as le,ProdWebpack as oo}from"../../configs/webpack/index.js";import{BUILD_TEXT as ro}from"../../constants/i18n/index.js";import{AbsPath as E,BuildApp as rt,CheckParams as it,IsPath as tt,JudgeFile as i,ShowMsg as et,ShowTitle as gt,UploadFiles as pt,WatchFiles as ft}from"../../constants/util/index.js";import{BuildAnswer as zo}from"../../helpers/answer/index.js";export default async function Ve(){gt("build");const e=i("","configFile"),o=i("src");if(it(),!e)return et("red",ro.judgeBrucerc),Ho(1);if(!o)return et("red",ro.judgeIndexes),Ho(1);if(!tt("package.json"))return et("red",ro.judgePackage),Ho(1);if(!tt("node_modules"))return et("red",ro.judgeModules),Ho(1);const t={...await zo(),...await c()};if(t.useTs&&!tt("tsconfig.json"))return et("red",ro.judgeTsconfig),Ho(1);if("dev"===t.mode){const e=_e(ro.doing1).start(),o=le(t),r=N(o),s=new Ue({allowedHosts:"all",headers:{"Access-Control-Allow-Origin":"*"},historyApiFallback:!0,host:t?.proxyHost||"local-ip",hot:!0,open:!!t.useOpener&&(!t.openPages?.length||t.openPages.filter(Boolean)),port:t.port,proxy:t.proxy,server:t.useHttps?"https":"http",static:{directory:E("dist")}},r);e.stop(),await s.start(),ft((e=>{console.log(ro.watch(e)),Ho(1)}))}else{const{name:e,version:o}=l("package.json"),r=_e(ro.doing1).start(),s=oo(t);!t.useTimer&&await kt(`dist/${t.mode}`),r.stop();const[n,i]=await rt(s),d=s.output.path;if(n||!i)et("red",ro.undone1({mode:t.mode,name:e,ver:o})),t?.buildErrorCb?.({err:n,mode:t.mode,path:d}),Ho(1);else{if(et("green",ro.done1({mode:t.mode,name:e,ver:o})),t?.buildSuccessCb?.({mode:t.mode,path:d}),t.uploadOpts){const e=_e(ro.doing2).start(),o=await pt({mode:t.mode,opts:t.uploadOpts,path:d});e.stop(),o?et("green",ro.done2):et("red",ro.undone2)}Ho(1)}}}