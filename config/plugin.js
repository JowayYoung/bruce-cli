const e=require("fs"),s=require("webpack"),i=require("webpackbar"),t=require("webpack-build-notifier"),n=require("webpack-bundle-analyzer").BundleAnalyzerPlugin,l=require("clean-webpack-plugin"),r=require("compression-webpack-plugin"),a=require("fork-ts-checker-webpack-plugin"),h=require("friendly-errors-webpack-plugin"),c=require("html-webpack-plugin"),u=require("html-webpack-tags-plugin"),o=require("lodash-webpack-plugin"),p=require("mini-css-extract-plugin"),d=require("webpack-spritesmith"),m=require("stylelint-webpack-plugin"),g=require("uglifyjs-webpack-plugin"),{style:f,stylelintIgnores:b,stylelintRules:w,useTs:y}=require("./bruce"),{ACTION_TEXT:k}=require("../i18n"),{AbsPath:E,IsExist:q,ReadEntry:S}=require("../util/setting");module.exports=class{constructor(l){const{MODE:c="dll",USE_ANALYZE:S=!1,USE_COMPRESS:v=!1,USE_CSSLINT:P=!1,USE_HASH:j=!1,USE_JSLINT:C=!1,USE_POLYFILL:N=!1}=l;this.mode=c,this.useCsslint=P,this.useJslint=C,this.usePolyfill=N,this.useHash=j,this.useCompress=v,this.useAnalyze=S,this.define=new s.DefinePlugin({RUN_ENV:JSON.stringify(this.mode)}),this.bar=new i({name:"Webpack Build"}),this.spritesmith=q("src/assets/icon")&&e.readdirSync(E("src/assets/icon")).length?new d({apiOptions:{cssImageRef:"~sprite.png"},spritesmithOptions:{algorithm:"binary-tree"},src:{cwd:E("src/assets/icon"),glob:"*.png"},target:{css:E("src/assets/css/sprite.css"),image:E("src/assets/img/sprite.png")}}):null,this.stylelint=this.useCsslint?new m({cache:!0,cacheLocation:E("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:E("../package.json",1),configOverrides:{ignoreFiles:b.map(e=>E(e)),rules:w},context:"src",fix:!1,syntax:f}):null,"dll"===this.mode?(this.defineDllEnv=new s.DefinePlugin({"process.env.NODE_ENV":JSON.stringify("dev")}),this.dll=new s.DllPlugin({name:"[name]",path:E("dist/static/[name]-manifest.json")}),this.uglifyjs=new g({cache:!0,parallel:!0})):"dev"===this.mode?(this.dllReference=q("dist/static")?new s.DllReferencePlugin({manifest:require(E("dist/static/vendor-manifest.json"))}):null,this.hotModuleReplacement=new s.HotModuleReplacementPlugin,this.forkTsChecker=this.useJslint&&y?new a({reportFiles:["src/**/*.{ts,tsx}"],tsconfig:E("tsconfig.json"),tslint:q("tslint.json")?E("tslint.json"):E("../temp/configs/tslint.json",1)}):null,this.friendlyErrors=new h,this.htmlTags=q("dist/static")?new u({append:!1,publicPath:"/",tags:["static/vendor.dll.js"]}):null):(this.buildNotifier=new t({suppressSuccess:!0,suppressWarning:!0,title:k.build}),this.bundleAnalyzer=this.useAnalyze?new n({analyzerPort:9090}):null,this.compression=this.useCompress?new r({test:/\.(css|js)$/,threshold:10240}):null,this.htmlTags=this.usePolyfill?new u({append:!1,publicPath:!1,tags:["https://cdn.polyfill.io/v2/polyfill.min.js"]}):null,this.lodash=new o,this.miniCssExtract=new p({filename:`css/[name].bundle${this.useHash?".[contenthash:4]":""}.css`}))}clean(...e){return new l({cleanOnceBeforeBuildPatterns:e.map(e=>E(`dist/${e}`))})}html(){const e=S();return e.map(s=>{const i={chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:E("src/assets/img/favicon.ico"),filename:`${s}.html`,minify:"dev"!==this.mode&&{collapseWhitespace:!0,removeComments:!0},template:E(`src${e.length>1?`/pages/${s}`:""}/index.html`)};return e.length>1&&Object.assign(i,{chunks:["manifest","vendor","common",s]}),new c(i)})}getPlugin(){let e=[];return(e="dll"===this.mode?[this.define,this.defineDllEnv,this.dll,this.bar,this.uglifyjs,this.clean("static")]:"dev"===this.mode?[this.define,this.dllReference,this.hotModuleReplacement,this.bar,this.forkTsChecker,this.friendlyErrors,this.spritesmith,this.stylelint,...this.html(),this.htmlTags]:[this.define,this.bar,this.buildNotifier,this.bundleAnalyzer,this.compression,this.lodash,this.miniCssExtract,this.spritesmith,this.stylelint,this.clean(this.mode),...this.html(),this.htmlTags]).filter(Boolean)}};