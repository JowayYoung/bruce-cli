var g=this&&this.__awaiter||function(e,o,s,n){return new(s||(s=Promise))((function(i,l){function t(e){try{d(n.next(e))}catch(e){l(e)}}function r(e){try{d(n.throw(e))}catch(e){l(e)}}function d(e){var o;e.done?i(e.value):(o=e.value,o instanceof s?o:new s((function(e){e(o)}))).then(t,r)}d((n=n.apply(e,o||[])).next())}))};import{exit as o}from"process";import{CheckPath as Nt,ReadJson as l,RemoveDir as ze}from"@yangzw/bruce-us/dist/node.js";import Ae from"ora";import{CreateWebpack as ie,ParseConfig as H}from"../configs/index.js";import{BuildAnswer as ut}from"../helpers/index.js";import{BUILD_TEXT as TT}from"../langs/index.js";import{JudgeFile as k,ShowTitle as Je}from"../utils/index.js";export default function d(e){var s;return g(this,void 0,void 0,(function*(){Je("build");const n=k("","configFile"),i=k("src"),{buildError:t,buildSuccess:r,useTs:d}=yield H();n||(console.log(TT.judgeBrucerc),o(1)),Nt("node_modules")||(console.log(TT.judgeModules),o(1)),Nt("package.json")||(console.log(TT.judgePackage),o(1)),d&&!Nt("tsconfig.json")&&(console.log(TT.judgeTsconfig),o(1)),i||(console.log(TT.judgeIndexes),o(1));const{analyze:a,compress:u,lintcss:c,lintjs:m,mode:f,named:g,polyfill:p,timed:j}=e,y=a||u||c||m||f||g||p||j?{mode:""===f?"prod":f,polyfill:""===p?"es6":p,useAnalyzer:a,useCompressor:u,useCsslint:c,useHash:g,useJslint:m,useTimer:j}:yield ut(),h=Ae(TT.doing).start(),{mode:v,useAnalyzer:x,useTimer:w}=y,{name:T="unknown",version:b="1.0.0"}=null!==(s=l("package.json"))&&void 0!==s?s:{};!w&&ze(`dist/${f}`),h.stop();const{dist:C,flag:z}=yield ie(y);z?(console.log(TT.done(T,b,v)),yield null==r?void 0:r({dist:C,mode:v})):(console.log(TT.undone),yield null==t?void 0:t({dist:C,mode:v})),!x&&o(1)}))}