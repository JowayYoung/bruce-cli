var g=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))((function(o,n){function r(t){try{c(i.next(t))}catch(t){n(t)}}function l(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,l)}c((i=i.apply(t,e||[])).next())}))};import{watch as x}from"fs";import{basename as w,dirname as s}from"path";import{fileURLToPath as i}from"url";import _ from"@vitejs/plugin-basic-ssl";import F from"@vitejs/plugin-react";import{AbsPath as $,IsEmptyObject as N}from"@yangzw/bruce-us/dist/node.js";import S from"eslint-formatter-pretty";import P from"open";import J from"postcss-preset-env";import R from"stylelint-formatter-pretty";import{createServer as z}from"vite";import A from"vite-plugin-eslint";import I from"vite-plugin-html-config";import{viteStaticCopy as L}from"vite-plugin-static-copy";import U from"vite-plugin-stylelint";import{JudgeFile as k}from"../utils/index.js";import H from"./parse-config.js";export default function V(t){return g(this,void 0,void 0,(function*(){const e=s(i(import.meta.url)),{alias:o,browsers:n,copyFiles:r,eslintIgnores:l,eslintRules:c,linkAssets:a,openPages:p,proxy:m,proxyHost:f,scriptAssets:u,style:d,stylelintIgnores:y,stylelintRules:v}=yield H(),{port:h,useCsslint:j,useHttps:b,useJslint:O,useOpener:C}=t,E=yield z({configFile:!1,css:{postcss:{plugins:[J({browsers:n})]}},define:{"process.env.NODE_ENV":JSON.stringify("development"),RUN_ENV:JSON.stringify("dev")},mode:"development",plugins:[b?_():null,O?A({cacheLocation:$("node_modules/.cache/eslint-vite-plugin/.eslintcache"),exclude:["node_modules",...l].map((t=>$(t))),extensions:["js","ts","jsx","tsx"],formatter:S,overrideConfig:{rules:c},overrideConfigFile:$("../../node_modules/@yangzw/bruce-std/dist/eslintrc.js",e)}):null,F(),I({favicon:"favicon.ico",links:"function"==typeof a?a("dev"):a,scripts:[..."function"==typeof u?u("dev"):u,{src:`./${w(k("src"))}`,type:"module"}]}),L({targets:("function"==typeof r?r("dev"):r).filter((t=>t.from.startsWith("src"))).map((t=>({dest:t.to,src:t.from.replace(/^(src)?\/?/,"")})))}),j?U(Object.assign({cacheLocation:$("node_modules/.cache/stylelint-vite-plugin/.stylelintcache"),configFile:$("../../node_modules/@yangzw/bruce-std/dist/stylelintrc.js",e),customSyntax:`postcss-${d}`,exclude:["node_modules",...y].map((t=>$(t))),formatter:R},N(v)?{}:{config:{rules:v}})):null].filter(Boolean),resolve:{alias:Object.assign({"@":$("src")},o),mainFields:["module","jsnext","jsnext:main","browser","main"]},root:$("./src"),server:{host:b&&f||"127.0.0.1",https:b,port:h,proxy:m}});yield E.listen(),E.printUrls();const V=[...new Set(p.length?p:[""])];if(C){const{host:t,port:e}=E.config.server;yield V.reduce(((s,i)=>g(this,void 0,void 0,(function*(){const o=/^https:?/.test(i)?i:`${b?"https":"http"}://${t}:${e}${i.startsWith("/")?i:`/${i}`}`;yield s,yield P(o,{app:{name:"browser"}})}))),Promise.resolve())}const W=k("","configFile"),B=w(W);x(W,{persistent:!0},((t,e)=>g(this,void 0,void 0,(function*(){"change"===t&&e===B&&(yield E.close(),yield E.restart())}))))}))}