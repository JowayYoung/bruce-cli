const e=require("fs"),r=require("util"),t=require("chalk"),s=require("chokidar"),i=require("easy-table"),n=require("open"),o=require("ora"),c=require("scp2"),l=require("webpack"),a=require("webpack-dev-server"),{errorCb:u,openPath:d,proxy:p,successCb:g,uploadOpts:f}=require("../config/bruce"),{BUILD_TEXT:b,FormatBool:S}=require("../i18n"),{BuildAnswer:h,DllAnswer:j}=require("../pipe"),{HOST:y,IGNORE_DEPS:E}=require("../util/getting"),{AbsPath:q,AsyncTo:w,BuildCb:O,DataType:k,DiffArray:x,GetUrl:U,IsEmptyArray:_,IsExist:m,IsMpa:A,ReadEntry:L,ReadFolder:P,ShowMsg:B,ShowTitle:D}=require("../util/setting");function T(e){let r=!1;if(A()){const t=P("src/pages");t.reduce((r,t)=>{const s=`src/pages/${t}/index.${e?"tsx":"jsx"}`,i=s.replace(/sx*$/g,"s");return m(s)&&(r+=1),m(i)&&(r+=1),r},0)===t.length&&(r=!0)}else{let t=0;const s=`src/index.${e?"tsx":"jsx"}`,i=s.replace(/sx*$/g,"s");m(s)&&(t+=1),m(i)&&(t+=1),1===t&&(r=!0)}return r}function F(r){const t=L();return t.reduce((s,i)=>{const n=`src${t.length>1?`/pages/${i}`:""}/index.${r?"tsx":"jsx"}`,o=n.replace(/sx/g,"s"),c=m(n)?q(n):m(o)?q(o):"";if(c){const r=["@babel/polyfill","core-js","regenerator-runtime"],t=e.readFileSync(c,"utf8");return r.some(e=>t.includes(e))?s+1:s}return s},0)>0}function v(){const{dependencies:e={}}=require(q("package.json")),r=require(q("dist/static/vendor.json")),t=Object.keys(e).sort().reduce((e,r)=>(E.every(e=>!r.includes(e))&&e.push(r),e),[]),s=x(r,t),i=x(t,r);return _(s)&&_(i)}async function I(){const{VENDOR:r}=await j(),t=require("../config/webpack.dll"),[s,i]=await O(t(r));if(s||!i)B("red",b.dllFail);else{const t=q("dist/static/vendor.json"),s=JSON.stringify(r,null,"\t");e.writeFileSync(t,s,"utf8"),B("green",b.dllSucceed)}}function $(e){const{MODE:r,USE_ANALYZE:s,USE_COMPRESS:n,USE_CSSLINT:o,USE_ES6:c,USE_HASH:l,USE_JSLINT:a,USE_POLYFILL:u,USE_TIMED:d,USE_UPLOAD:p}=e,{name:g}=require(q("package.json")),f={name:g,mode:b.table.env[r],csslint:o,jslint:a,es6:c,polyfill:u,hash:l,timed:d,compress:n,analyze:s,upload:p},h=new i;Object.entries(f).forEach((e,r)=>{if(void 0!==e[1]){const s=b.table[e[0]],i=k(e[1],"boolean")?S(e[1]):e[1];h.cell("title",t[`bg${r%2==0?"Blue":"Magenta"}Bright`](s)),h.cell("desc",t.cyanBright(i)),h.newRow()}}),console.log("\n"+h.print())}async function M(e){const t=r.promisify(c.scp)(q(`dist/${e}`),f(e)),s=o(b.uploading);s.start();const[i]=await w(t);s.stop(),i?(console.log(i),B("red",b.uploadFail)):B("green",b.uploadSucceed)}module.exports=async function(){if(D("build"),!m("brucerc.js"))return B("red",b.judgeBrucerc);if(!m("package.json"))return B("red",b.judgePackage);if(!m("src"))return B("red",b.judgeSrc);if(!m("node_modules"))return B("red",b.judgeModules);const{frame:e,useTs:r}=require("../config/bruce"),{dependencies:{"@babel/polyfill":i,"core-js":o}}=require(q("package.json")),c=F(r);if(r&&!m("tsconfig.json"))return B("red",b.judgeTsconfig);if(!T(r))return B("red",b.judgeEntry);if(c){if(i)return B("red",b.judgePolyfill);if(o&&o>="3.0.0")return B("red",b.judgeCorejs)}"default"===e||m("dist/static")&&v()||await I();const S=await h(c),{MODE:j}=S;if("dev"===j){const{PORT:e,USE_OPEN:r}=S,i=require("../config/webpack.dev"),o=l(i(S)),c=new a(o,{contentBase:q("dist"),disableHostCheck:!0,historyApiFallback:!0,host:y,hot:!0,open:!1,overlay:!0,port:e,proxy:p,publicPath:U(e)+"/",quiet:!0}),u=s.watch([q("brucerc.js"),q("package.json")]);c.listen(e,y,s=>{if(s)B("red",b.buildFail);else{const s=U(e,d),i=U(e,d,!0);console.log(t.yellowBright(b.listening)),console.log(b.listLocalhost+t.blueBright(s)),console.log(b.listNetwork+t.blueBright(i)),r&&n(s,{app:"chrome"})}}),u.on("change",e=>{const r=e.split("\\").pop();console.log(b.watch(r)),process.exit(1)})}else{$(S);const{MODE:e,USE_UPLOAD:r}=S,t=require("../config/webpack.prod")(Object.assign(S,{HAS_POLYFILL:c})),[s,i]=await O(t);s||!i?(B("red",b.buildFail),u&&u(s)):(B("green",b.buildSucceed),g&&g(e,t.output.path),r&&f&&M(e))}};