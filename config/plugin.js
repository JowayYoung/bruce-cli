const e=require("fs"),s=require("webpack"),i=require("webpackbar"),t=require("webpack-build-notifier"),n=require("webpack-bundle-analyzer").BundleAnalyzerPlugin,l=require("clean-webpack-plugin").CleanWebpackPlugin,r=require("compression-webpack-plugin"),a=require("eslint-webpack-plugin"),h=require("friendly-errors-webpack-plugin"),c=require("hard-source-webpack-plugin"),u=require("html-webpack-plugin"),o=require("html-webpack-tags-plugin"),d=require("lodash-webpack-plugin"),p=require("mini-css-extract-plugin"),m=require("webpack-spritesmith"),g=require("stylelint-webpack-plugin"),f=require("tinyimg-webpack-plugin"),w=require("uglifyjs-webpack-plugin"),b=require("vue-loader").VueLoaderPlugin,y=require("eslint-friendly-formatter"),{eslintIgnores:v,eslintRules:q,frame:k,stylelintIgnores:E,stylelintRules:P,useTs:S}=require("./bruce"),{ACTION_TEXT:j}=require("../i18n"),{AbsPath:C,IsExist:x,ReadEntry:L}=require("../util/setting");module.exports=class{constructor(l){const{MODE:u="dll",USE_ANALYZE:L=!1,USE_COMPRESS:N=!1,USE_CSSLINT:O=!1,USE_HASH:R=!1,USE_JSLINT:_=!1,USE_POLYFILL:A=!1}=l;this.mode=u,this.useAnalyze=L,this.useCompress=N,this.useCsslint=O,this.useHash=R,this.useJslint=_,this.usePolyfill=A,this.define=new s.DefinePlugin({RUN_ENV:JSON.stringify(this.mode)}),this.bar=new i({name:"Webpack Build"}),this.eslint=this.useJslint&&new a({cache:!0,cacheLocation:C("node_modules/.cache/eslint-webpack-plugin/.eslintcache"),context:C("src"),extensions:["js","ts","jsx","tsx","vue"],formatter:y,overrideConfig:{ignorePatterns:v,rules:q},overrideConfigFile:C(`../temp/configs/${S?"ts":"es"}lintrc.${k}.js`,1)}),this.hardSource=new c,this.spritesmith=x("src/assets/icon")&&!!e.readdirSync(C("src/assets/icon")).length&&new m({apiOptions:{cssImageRef:"~sprite.png"},spritesmithOptions:{algorithm:"binary-tree"},src:{cwd:C("src/assets/icon"),glob:"*.png"},target:{css:C("src/assets/css/sprite.css"),image:C("src/assets/img/sprite.png")}}),this.stylelint=this.useCsslint&&new g({cache:!0,cacheLocation:C("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:C(`../temp/configs/stylelintrc.${k}.js`,1),configOverrides:{ignoreFiles:E.map((e=>C(e))),rules:P},context:C("src"),files:"**/*.{html,css,sass,scss,less,vue}"}),this.vueLoader="vue"===k&&new b,"dll"===this.mode?(this.defineDllEnv=new s.DefinePlugin({"process.env.NODE_ENV":JSON.stringify("development")}),this.dll=new s.DllPlugin({name:"[name]",path:C("dist/static/[name]-manifest.json")}),this.uglifyjs=new w({cache:!0,parallel:!0})):"dev"===this.mode?(this.dllReference=x("dist/static")&&new s.DllReferencePlugin({manifest:require(C("dist/static/vendor-manifest.json"))}),this.hotModuleReplacement=new s.HotModuleReplacementPlugin,this.friendlyErrors=new h,this.htmlTags=x("dist/static")&&new o({append:!1,publicPath:"/",tags:["static/vendor.dll.js"]})):(this.buildNotifier=new t({suppressSuccess:!0,suppressWarning:!0,title:j.build}),this.bundleAnalyzer=this.useAnalyze&&new n({analyzerPort:9090}),this.compression=this.useCompress&&new r({test:/\.(css|js)$/,threshold:10240}),this.htmlTags=this.usePolyfill&&new o({append:!1,publicPath:!1,tags:["https://cdn.polyfill.io/v2/polyfill.min.js"]}),this.lodash=new d,this.miniCssExtract=new p({filename:`css/[name].bundle${this.useHash?".[contenthash:4]":""}.css`}),this.tinyimg=this.tinyimg=new f({enabled:!0,logged:!0}))}clean(...e){return new l({cleanOnceBeforeBuildPatterns:e.map((e=>C("dist/"+e))),dry:!0})}html(){const e=L();return e.map((s=>{const i={chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:C("src/assets/img/favicon.ico"),filename:s+".html",minify:"dev"!==this.mode&&{collapseWhitespace:!0,removeComments:!0},template:C(`src${e.length>1?"/pages/"+s:""}/index.html`)};return e.length>1&&Object.assign(i,{chunks:["manifest","vendor","common",s]}),new u(i)}))}getPlugin(){let e=[];return e="dll"===this.mode?[this.define,this.defineDllEnv,this.dll,this.bar,this.uglifyjs,this.clean("static")]:"dev"===this.mode?[this.define,this.dllReference,this.hotModuleReplacement,this.bar,this.eslint,this.friendlyErrors,this.spritesmith,this.stylelint,this.vueLoader,...this.html(),this.htmlTags]:[this.define,this.bar,this.buildNotifier,this.bundleAnalyzer,this.compression,this.eslint,this.hardSource,this.lodash,this.miniCssExtract,this.spritesmith,this.stylelint,this.tinyimg,this.vueLoader,this.clean(this.mode),...this.html(),this.htmlTags],e.filter(Boolean)}};